services:
  gmail-r2-backup:
    build: .
    # Dockerfile sets ENTRYPOINT to `gmail-r2-backup`. For a long-running Coolify "worker"
    # container, override it so the container stays up and Scheduled Tasks can exec the CLI.
    # Use `-c` (not `-lc`) to avoid resetting PATH via login shell profiles.
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    healthcheck:
      # No HTTP server here. We just validate the CLI is runnable and dependencies are intact.
      test: ["CMD-SHELL", "gmail-r2-backup --help >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      # Ensure scheduled tasks can call `gmail-r2-backup` without an absolute path.
      - PATH=/app/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      # Set these in Coolify (recommended) or via a local .env file.
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_REGION=${R2_REGION:-auto}
      # IMPORTANT: do not set R2_PREFIX if you plan to use --auto-prefix for multiple accounts.
    volumes:
      - gmail-r2-backup-state:/state

volumes:
  gmail-r2-backup-state:
